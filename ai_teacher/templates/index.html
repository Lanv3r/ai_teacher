{% extends "base.html" %}
{% block content %}

<div class="row">
  <div class="card" id="add-task-window">
    <h3>Add Task</h3>
    <form method="post" action="/add-task" style="max-width: 400px;">
      <div style="display: flex; gap: 8px;">
        <label>Task</label><br>
        <input name="name" placeholder="e.g., Read Chapter 1" required style="padding: 8px;"/>
      </div>
      <div style="display: flex; gap: 8px;">
        <label for="amount" style="margin-right: 10px;">Estimated Time</label>
        
        <input type="number" id="time_amount" name="time_amount" min="1" step="1" required />
        
        <select name="time_unit" id="time_unit">
          <option value="minutes">Minutes</option>
          <option value="hours">Hours</option>
          <option value="days">Days</option>
        </select>
      </div>
      <div style="display: flex; gap: 8px;">
        <label>Deadline</label><br>
        <input name="deadline" type="date" required />
      </div>
      <div style="margin-top:10px; position: relative; display: inline-block;">
        <button class="btn" id="add-task-btn" type="submit">Add Task</button>
      </div>
    </form>
  </div>

  <div class="card" id="study-window">
    <h3>Popular Study & Time-Management Techniques</h3>
    <form method="post" action="/save-preferences">
      <div class="row">
        <div>
          <label>Pomodoro Technique</label><br>
          <img class="img-option" src="{{ url_for('static', filename='img/pomodoro.png') }}" alt="Pomodoro">
        </div>
        <div>
          <label>90/20 Rule</label><br>
          <img class="img-option" src="{{ url_for('static', filename='img/flow_state.png') }}" alt="90/20 Rule">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Work block (min)</label><br>
          <input type="number" name="work_block_minutes" value="{{ prefs.work_block_minutes }}" min="15" step="5" />
        </div>
        <div>
          <label>Short break (min)</label><br>
          <input type="number" name="short_break_minutes" value="{{ prefs.short_break_minutes }}" min="0" step="5" />
        </div>
        <div>
          <label>Long break every (blocks)</label><br>
          <input type="number" name="long_break_every_blocks" value="{{ prefs.long_break_every_blocks }}" min="0" />
        </div>
        <div>
          <label>Long break (min)</label><br>
          <input type="number" name="long_break_minutes" value="{{ prefs.long_break_minutes }}" min="0" step="5" />
        </div>
      </div>

      <h4>Study Windows</h4>
      <p class="muted">Set time windows for each day you are comfortable studying.</p>
      <table>
        <thead>
          <tr><th>Day</th><th>Start</th><th>End</th></tr>
        </thead>
        <tbody>
          {% for wd in range(7) %}
          <tr>
            <td>{{ ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][wd] }}</td>
            {% set win = None %}
            {% for w in prefs.study_windows %}
              {% if w.weekday == wd %}
                {% set win = w %}
              {% endif %}
            {% endfor %}
            <td><input type="time" name="start_{{ wd }}" value="{{ win.start if win else '' }}" /></td>
            <td><input type="time" name="end_{{ wd }}" value="{{ win.end if win else '' }}" /></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="margin-top:10px;">
        <button class="btn" type="submit">Save Preferences</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    const btn = document.getElementById('add-task-btn');
    if (!btn) return;

    // Fire on successful redirect after submit using sessionStorage flag
    if (sessionStorage.getItem('justAdded') === '1') {
      sessionStorage.removeItem('justAdded');
      const wrapper = btn.parentElement;
      const burst = document.createElement('div');
      burst.className = 'burst';
      burst.setAttribute('aria-hidden', 'true');
      for (let i = 0; i < 8; i++) {
        const p = document.createElement('div');
        p.className = 'burst__particle';
        burst.appendChild(p);
      }
      wrapper.appendChild(burst);
      setTimeout(() => { burst.remove(); }, 800);
    }

    // Set the flag on submit so the next page load triggers the burst
    const form = btn.closest('form');
    if (form) {
      form.addEventListener('submit', function() {
        sessionStorage.setItem('justAdded', '1');
      });
    }
  })();
  </script>

<div class="card" id="tasks-window" style="margin-top:20px;">
  <h3>Tasks</h3>
  {% if tasks %}
  <table>
    <thead>
      <tr><th>Name</th><th>Minutes</th><th>Deadline</th><th></th></tr>
    </thead>
    <tbody>
      {% for t in tasks %}
      <tr>
        <td>{{ t.name }}</td>
        <td>{{ t.minutes }}</td>
        <td>{{ t.deadline }}</td>
        <td><a class="btn btn-danger" href="/delete-task/{{ t.id }}">Delete</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div style="margin-top:10px;">
    <a class="btn btn-secondary" href="/schedule">Generate Schedule</a>
  </div>
  {% else %}
  <p class="muted">No tasks yet. Add some above.</p>
  {% endif %}
</div>

{% endblock %}


